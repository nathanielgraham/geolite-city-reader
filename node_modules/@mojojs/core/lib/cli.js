import * as util from './util.js';
import Path from '@mojojs/path';
import nopt from 'nopt';
/**
 * Command line interface class.
 */
export class CLI {
    constructor(app) {
        /**
         * Paths to search for commands.
         */
        this.commandPaths = [Path.currentFile().sibling('cli').toString()];
        /**
         * Registered commands.
         */
        this.commands = {};
        this._loaded = undefined;
        this._app = new WeakRef(app);
    }
    /**
     * Add a command.
     */
    addCommand(name, command) {
        this.commands[name] = command;
    }
    /**
     * Start command line interface.
     */
    async start(command, ...args) {
        if (this._loaded === undefined)
            await this._loadCommands();
        const commandArgs = command === undefined ? process.argv : ['', '', command, ...args];
        const app = this._app.deref();
        if (app === undefined)
            return;
        await app.hooks.runHook('command:before', app, commandArgs);
        const parsed = nopt({ help: Boolean }, { h: '--help' }, commandArgs);
        const argv = parsed.argv;
        if (argv.remain.length > 0) {
            const name = argv.original[0];
            const command = this.commands[name];
            if (command === undefined) {
                process.stdout.write(`Unknown command "${name}", maybe you need to install it?\n`);
            }
            else if (parsed.help === true) {
                process.stdout.write(command.usage);
            }
            else {
                await command(app, argv.original);
            }
        }
        else {
            await this._listCommands();
        }
        await app.hooks.runHook('command:after', app, commandArgs);
    }
    async _listCommands() {
        const commands = Object.keys(this.commands)
            .sort()
            .map(name => [` ${name}`, this.commands[name].description]);
        process.stdout.write(header + util.tablify(commands) + footer);
    }
    async _loadCommands() {
        this._loaded = true;
        for (const [name, command] of Object.entries(await util.loadModules(this.commandPaths))) {
            this.addCommand(name, command);
        }
    }
}
const header = `Usage: APPLICATION COMMAND [OPTIONS]

  node index.js server -l http://*:8080
  node index.js get /foo

Commands:
`;
const footer = `
See 'APPLICATION COMMAND --help' for more information on a specific command.
`;
//# sourceMappingURL=cli.js.map